<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Checkout — AsSip</title>
  <style>
    body{font-family:system-ui, -apple-system, "Segoe UI",Roboto,Arial;background:#faf8f6;color:#222;margin:0}
    .container{max-width:820px;margin:28px auto;padding:0 16px}
    .card{background:#fff;padding:18px;border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,0.06);margin-bottom:18px}
    label{display:block;margin-bottom:6px;font-weight:600}
    input,textarea,select{width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-bottom:10px}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .summary-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dashed #eee}
    .total{font-weight:800;font-size:18px;margin-top:12px}
    .btn{background:#0b6b3a;color:white;padding:10px 14px;border:none;border-radius:8px;cursor:pointer;font-weight:700}
    .small{font-size:13px;color:#666}
  </style>
</head>
<body>
  <div class="container">
    <h2>Checkout</h2>

    <div class="card" id="orderSummaryCard">
      <div style="font-weight:700;margin-bottom:8px;">Order Summary</div>
      <div id="orderItems"></div>
      <div id="orderSubtotal" class="total"></div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:8px;">Shipping details</div>
      <label for="name">Full name</label>
      <input id="name" placeholder="Your full name">
      <label for="phone">Phone number</label>
      <input id="phone" placeholder="98xxxxxxxx">
      <label for="address">Address</label>
      <textarea id="address" rows="3" placeholder="Street, area, landmark, city, state, pincode"></textarea>
      <div class="row">
        <div class="col"><label for="city">City</label><input id="city" placeholder="City"></div>
        <div class="col"><label for="pincode">Pincode</label><input id="pincode" placeholder="Pincode"></div>
      </div>
    </div>

    <div class="card">
      <div style="font-weight:700;margin-bottom:8px;">Payment</div>
      <div class="small">Choose payment method</div>
      <label for="paymentMethod">Payment method</label>
      <select id="paymentMethod">
        <option value="cod">Cash on Delivery (COD)</option>
        <option value="online">Pay Online (Razorpay)</option>
      </select>
      <div style="margin-top:12px;">
        <button id="placeOrder" class="btn">Place Order</button>
      </div>
    </div>

    <div id="orderResult" style="margin-top:14px"></div>
  </div>

<script type="module">
  // =========== CONFIG - replace these BEFORE testing/deploy ===========
  // Keep SERVER_BASE as placeholder for now; we'll deploy server later and set it.
  const SERVER_BASE = 'https://REPLACE_WITH_YOUR_SERVER_URL';
  // Get test key from Razorpay dashboard later (starts with rzp_test_)
  const RAZORPAY_KEY_ID = 'rzp_test_REPLACE_WITH_KEYID';

  // Your Firebase config (already in auth.html & account.html)
  const firebaseConfig = {
    apiKey: "AIzaSyAUZmRz36SioY54OEIr_DpeCpvJsBMSWec",
    authDomain: "assip-29f4e.firebaseapp.com",
    projectId: "assip-29f4e",
    storageBucket: "assip-29f4e.appspot.com",
    messagingSenderId: "1025217536664",
    appId: "1:1025217536664:web:c8a39df26959ef9ef626ed",
    measurementId: "G-N4MWTTQ7Q2"
  };
  // ==================================================================

  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-app.js";
  import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.24.0/firebase-auth.js";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // helper cart functions (uses localStorage)
  function getCart(){ return JSON.parse(localStorage.getItem('assip_cart') || '[]'); }
  function clearCart(){ localStorage.removeItem('assip_cart'); }
  function currency(v){ return '₹' + v; }

  // render cart summary
  function renderOrder(){
    const cart = getCart();
    const container = document.getElementById('orderItems');
    container.innerHTML = '';
    if(cart.length===0){ container.innerHTML = '<div class="small">No items in cart. Go add some delicious tea!</div>'; document.getElementById('orderSubtotal').textContent=''; return; }
    let subtotal = 0;
    cart.forEach(it => {
      const total = it.unitPrice * it.qty;
      subtotal += total;
      const el = document.createElement('div');
      el.className = 'summary-row';
      el.innerHTML = `<div><div style="font-weight:700">${it.name}</div><div class="small">${it.size} g • ${it.qty}pcs</div></div><div style="font-weight:700">${currency(total)}</div>`;
      container.appendChild(el);
    });
    document.getElementById('orderSubtotal').textContent = 'Subtotal • ' + currency(subtotal);
  }
  renderOrder();

  // SERVER calls require Firebase login - enforce auth
  let currentUser = null;
  onAuthStateChanged(auth, (u) => {
    currentUser = u;
    if(!u){
      if(confirm('You must sign in to place orders. Go to Sign In page?')) window.location.href = '/auth.html';
    }
  });

  // helper: create order on server (requires user's ID token)
  async function createRazorpayOrder(amountRupees){
    if(!currentUser) throw new Error('Not signed in');
    const idToken = await currentUser.getIdToken();
    const amountPaise = Math.round(amountRupees * 100);
    const resp = await fetch(SERVER_BASE + '/create-order', {
      method: 'POST',
      headers: {'Content-Type':'application/json','Authorization':'Bearer ' + idToken},
      body: JSON.stringify({ amount: amountPaise, currency: 'INR' })
    });
    if(!resp.ok) throw new Error('Order creation failed: ' + resp.status);
    return resp.json();
  }

  function loadRazorpayScript(){
    return new Promise((resolve,reject)=>{
      if(window.Razorpay) return resolve();
      const s = document.createElement('script');
      s.src = 'https://checkout.razorpay.com/v1/checkout.js';
      s.onload = ()=>resolve();
      s.onerror = ()=>reject(new Error('Razorpay script load failed'));
      document.body.appendChild(s);
    });
  }

  document.getElementById('placeOrder').addEventListener('click', async ()=>{
    const cart = getCart();
    if(cart.length===0){ alert('Cart empty'); return; }
    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const address = document.getElementById('address').value.trim();
    const city = document.getElementById('city').value.trim();
    const pincode = document.getElementById('pincode').value.trim();
    const method = document.getElementById('paymentMethod').value;
    if(!name || !phone || !address || !city || !pincode){ alert('Please fill shipping details'); return; }
    const subtotal = cart.reduce((s,i)=>s + (i.unitPrice*i.qty), 0);
    const orderResultEl = document.getElementById('orderResult');

    if(method === 'cod'){
      orderResultEl.innerHTML = `<div style="padding:12px;background:#e8ffe7;border-radius:10px;">✅ Order placed (Cash on Delivery). Total: ₹${subtotal}. We will contact you at ${phone}.</div>`;
      clearCart(); renderOrder(); return;
    }

    // Online payment
    try {
      if(!currentUser) throw new Error('Sign in required');
      await loadRazorpayScript();
      const { order } = await createRazorpayOrder(subtotal);
      const options = {
        key: RAZORPAY_KEY_ID,
        amount: order.amount,
        currency: order.currency,
        name: 'AsSip',
        description: 'Order from AsSip',
        order_id: order.id,
        prefill: { name, contact: phone },
        theme: { color: '#0b6b3a' },
        handler: async function(response){
          try {
            const idToken = await currentUser.getIdToken();
            const verifyResp = await fetch(SERVER_BASE + '/verify-payment', {
              method: 'POST',
              headers: {'Content-Type':'application/json','Authorization':'Bearer ' + idToken},
              body: JSON.stringify({
                razorpay_order_id: response.razorpay_order_id,
                razorpay_payment_id: response.razorpay_payment_id,
                razorpay_signature: response.razorpay_signature,
                orderMeta: { customer: { name, phone, address, city, pincode }, items: cart }
              })
            });
            const vr = await verifyResp.json();
            if(verifyResp.ok){
              orderResultEl.innerHTML = `<div style="padding:12px;background:#e8ffe7;border-radius:10px;">✅ Payment successful & verified. Order confirmed. Total: ₹${subtotal}</div>`;
              clearCart(); renderOrder();
            } else {
              orderResultEl.innerHTML = `<div style="padding:12px;background:#fff0f0;border-radius:10px;">⚠️ Payment verification failed: ${vr.message || 'unknown'}</div>`;
            }
          } catch(err){
            console.error(err);
            orderResultEl.innerHTML = `<div style="padding:12px;background:#fff0f0;border-radius:10px;">⚠️ Verification error: ${err.message}</div>`;
          }
        }
      };
      const rzp = new Razorpay(options);
      rzp.open();
    } catch(err){
      alert('Payment error: ' + (err.message || err));
      console.error(err);
    }
  });
</script>
</body>
</html>
